function initPage(){wx=parseInt($("meta[name='widget_base_width']").attr("content")),wy=parseInt($("meta[name='widget_base_height']").attr("content")),wm=$("meta[name='widget_margin']").attr("content")?parseInt($("meta[name='widget_margin']").attr("content")):5,doLongPoll="1"==$("meta[name='longpoll']").attr("content"),debuglevel=$("meta[name='debug']").attr("content")||0,DEBUG=debuglevel>0,TOAST="0"!=$("meta[name='toast']").attr("content"),dir=$('script[src$="fhem-tablet-ui.min.js"]').attr("src");var e=dir.split("/").pop();dir=dir.replace("/"+e,""),DEBUG&&console.log("Plugin dir: "+dir);var t=window.location.pathname;filename=t.substring(t.lastIndexOf("/")+1),DEBUG&&console.log("Filename: "+filename),gridster&&gridster.destroy(),gridster=$(".gridster > ul").gridster({widget_base_dimensions:[wx,wy],widget_margins:[wm,wm],draggable:{handle:"header"}}).data("gridster"),"1"==$("meta[name='gridster_disable']").attr("content")&&gridster.disable(),"1"==$("meta[name='gridster_starthidden']").attr("content")&&$(".gridster").hide();var a=$("[data-template]").length;a>0?$("[data-template]").each(function(e){$(this).load($(this).data("template"),function(){e===a-1&&initWidgets()})}):initWidgets()}function initReadingsArray(e){$.isArray(e)||(e=new Array(e));for(var t=0;t<e.length;t++){if(reading=e[t],reading.match(/:/)){var a=reading.split(":"),n=a[0];devices[n]||(devices[n]=!0,devs.push(n)),reading=a[1]}readings[reading]||(readings[reading]=!0,pars.push(reading))}}function initWidgets(){readings={STATE:!0},devices={},types={},updateStatus={},devs=new Array,pars=new Array,deviceStates=JSON.parse(localStorage.getItem("deviceStates"))||{},showDeprecationMsg(),$("div[data-type]").each(function(){var e=$(this).data("type");types[e]||(types[e]=!0)}),$("div[data-device]").each(function(){var e=$(this).data("device");devices[e]||(devices[e]=!0,devs.push(e))}),DEBUG&&console.log("Collecting required readings"),$("[data-get]").each(function(){initReadingsArray($(this).data("get"))});for(var e in types)plugins.load("widget_"+e);DEBUG&&console.log("Request readings from FHEM"),setTimeout(function(){for(var e in readings)requestFhem(e)},500)}function showDeprecationMsg(){$("div[type]").each(function(){$(this).attr({"data-type":$(this).attr("type")}).removeAttr("type"),console.log('Please rename widget attribute "type" into "data-type" in '+document.location+($(this).attr("data-device")?" device: "+$(this).attr("data-device"):"")+" - Details below:"),console.log($(this))}),$("div[device]").each(function(){$(this).attr({"data-device":$(this).attr("device")}).removeAttr("device"),console.log('Please rename widget attribute "device" into "data-device" in '+document.location+($(this).attr("data-device")?" device: "+$(this).attr("data-device"):"")+" - Details below:"),console.log($(this))}),$('div[data-type="contact"]').each(function(){$(this).attr({"data-type":"symbol"}),console.log('Please rename widget "contact" into "symbol" in '+document.location+($(this).attr("data-device")?" device: "+$(this).attr("data-device"):"")+" - Details below:"),console.log($(this))})}function startPollInterval(){clearInterval(timer),timer=setInterval(function(){updateStatus={};for(var e in readings)requestFhem(e)},shortpollInterval)}function setFhemStatus(e){startPollInterval(),DEBUG&&console.log("send to FHEM: "+e),$.ajax({async:!0,url:$("meta[name='fhemweb_url']").attr("content")||"/fhem/",data:{cmd:e,XHR:"1"}}).fail(function(e,t,a){$.toast("Error: "+t+": "+a)}).done(function(){doLongPoll||setTimeout(function(){for(var e in readings)requestFhem(e)},4e3)})}function longPoll(){DEBUG&&console.log("start longpoll"),xhr&&xhr.abort(),currLine=0,$.ajax({url:$("meta[name='fhemweb_url']").attr("content")||"/fhem/",cache:!1,complete:function(){setTimeout(function(){longPoll()},100)},timeout:6e4,async:!0,data:{XHR:1,inform:"type=raw;filter=.*"},xhr:function(){return xhr=new window.XMLHttpRequest,xhr.addEventListener("readystatechange",function(e){var t=e.target.responseText;if(4!=e.target.readyState&&3==e.target.readyState){var a=t.replace(/<br>/g,"").split(/\n/),n=/\s[0-2][0-9]:[0-5][0-9]:[0-5][0-9]\.?[0-9]{0,3}\s(\S*)\s(\S*)\s(.*)/,r=/^([0-9]{4}-[0-9]{2}-[0-9]{2}\s[0-2][0-9]:[0-5][0-9]:[0-5][0-9])\.?[0-9]{0,3}\s/,i=/^(\S{2,}):(?:\s(.*))?$/;a.pop();for(var o=currLine;o<a.length;o++){var s,d=$.trim(a[o]);if(r.test(d)&&(s=$.trim(d.match(r)[1])),n.test(d)){var l,c,u=$.trim(d.match(n)[1]),g=$.trim(d.match(n)[2]),m=$.trim(d.match(n)[3]),h=deviceStates[g]||{};if(i.test(m))var l=$.trim(m.match(i)[1]),c=$.trim(m.match(i)[2]);else var l="STATE",c=m;if("readingsGroup"==u&&g in devices||l in readings&&g in devices){var f={date:s,room:u,val:c};h[l]=f,deviceStates[g]=h,DEBUG&&console.log(s+" / "+g+" / "+l+" / "+c),plugins.update(g,l)}}}currLine=a.length}},!1),xhr}})}function requestFhem(e,t){var a;if(e.match(/:/)){var n=e.split(":");t=n[0],e=n[1]}a="undefined"!=typeof t&&"undefined"!==t?t:$.map(devs,$.trim).join(),"undefined"!=typeof e&&"undefined"!==e&&$.ajax({async:!0,timeout:15e3,cache:!1,context:{paraname:e},url:$("meta[name='fhemweb_url']").attr("content")||"/fhem/",data:{cmd:["list",a,e].join(" "),XHR:"1"}}).fail(function(e,t,a){$.toast("Error: "+t+": "+a)}).done(function(e){for(var t=e.replace(/\n\)/g,")\n").split(/\n/),a=/^(\S*)\s*([0-9]{4}-[0-9]{2}-[0-9]{2}\s[0-2][0-9]:[0-5][0-9]:[0-5][0-9])?\.?[0-9]{0,3}\s+(.*)$/,n=0;n<t.length;n++){var r="",i="",o="",s=$.trim(t[n]);if(debuglevel>=6&&console.log("line: "+s),a.test(s)){var d=s.match(a),l=this.paraname;if(i=$.trim(s.match(a)[1]),i in devices){d.length>2&&(r=$.trim(d[2]),o=$.trim(d[3])),debuglevel>=5&&console.log("requestFhem::done: Line parser result: key:"+i+" paraname:"+l+" date:"+r+" val:"+o);var c=getParameterByName(i,l);if(!c||c.val!=o||c.date!=r){var u=deviceStates[i]||{},g={date:r,val:o};u[l]=g,deviceStates[i]=u,plugins.update(i,l)}}}}var m=JSON.stringify(deviceStates);localStorage.setItem("deviceStates",m)})}function loadplugin(e,t,a,n){dynamicload("js/"+e+".js",t,a,n)}function dynamicload(e,t,a,n){var r=DEBUG?!1:!0;$.ajax({url:dir+"/../"+e,dataType:"script",cache:r,async:n||!1,context:{name:name},success:t||function(){return!0},error:a||function(){return!1}})}function loadStyleSchema(){$.each($('link[href$="-ui.css"]'),function(e,t){var a=t.sheet.cssRules;for(var n in a)if(a[n].style){var r=a[n].style.cssText.split(";");r.pop();var i=a[n].selectorText,o={};for(var s in r){var d=r[s].split(":");d[0].match(/color/)&&(o[$.trim(d[0])]=$.trim(d[1]))}Object.keys(o).length>0&&(styleCollection[i]=o)}})}var deviceStates={},readings={STATE:!0},devices={},types={},updateStatus={},DEBUG=!1,debuglevel,TOAST=!0,doLongPoll=!1,timer,timeoutMenu,dir="",filename="",shortpollInterval=3e4,devs=Array(),pars=Array(),gridster,styleCollection={},plugins={modules:[],addModule:function(e){this.modules.push(e)},load:function(name){loadplugin(name,function(){DEBUG&&console.log("Loaded plugin: "+name);var module=eval(name);plugins.addModule(module),module.init();for(var reading in readings)for(var device in devices)module.update(device,reading);for(var reading in readings)pars.indexOf(reading)<0&&pars.push(reading)},null,!0)},update:function(e,t){$.each(this.modules,function(a,n){n.update(e,t)}),DEBUG&&console.log("update done for device:"+e+" parameter:"+t)}};$(document).on("ready",function(){$("<div id='shade' />").prependTo("body").hide(),$("#shade").on("click",function(){$(document).trigger("shadeClicked")}),loadStyleSchema(),initPage(),doLongPoll&&(setTimeout(function(){longPoll()},1e4),shortpollInterval=9e5),$("*:not(select)").focus(function(){$(this).blur()}),startPollInterval()});var xhr,currLine=0;this.getPart=function(e,t){if($.isNumeric(t)){var a=e&&"undefined"!=typeof e?e.split(" "):"";return a.length>=t&&t>0?a[t-1]:e}if(e&&"undefined"!=typeof e)var n=e.match(new RegExp("^"+t+"$"));var r="";if(n)for(var i=1;i<n.length;i++)r+=n[i];return r},this.getDeviceValueByName=function(e,t){var a=getParameterByName(e,t);return a?a.val:null},this.getDeviceValue=function(e,t){var a=getParameter(e,t);return a?a.val:null},this.getReadingDateByName=function(e,t){var a=getParameterByName(e,t);return a?a.date:null},this.getReadingDate=function(e,t){var a=getParameter(e,t);return a?a.date:null},this.getParameterByName=function(e,t){if(e.match(/:/)){var a=e.split(":");e=a[0],t=a[1]}if(t=t||Object.keys(readings)[0],e&&e.length>0){var n=deviceStates[e];return n&&n[t]?n[t]:null}return null},this.getParameter=function(e,t){var a=e.data("device"),n=t&&""!=t?e.data(t):Object.keys(readings)[0];if(a&&a.length>0){var r=deviceStates[a];return r&&r[n]?r[n]:null}return null},this.hasSubscription=function(e,t){var a=e.data("get");$.isArray(a)||(a=new Array(a));var n;n=t.match(/,/)?t.split(","):new Array(t);for(var r=0;r<a.length;r++)for(var i=0;i<n.length;i++){var o;if(o=a[r]&&a[r].match(/:/)?a[r].split(":")[1]:a[r],n[i]==o)return!0}return!1},this.getStyle=function(e,t){var a=styleCollection[e];return a&&a[t]?a[t]:null},this.getIconId=function(e){if(!e||""==e)return"?";var t=$('link[href$="font-awesome.min.css"]')[0].sheet.cssRules;for(var a in t)if(t[a].selectorText&&t[a].selectorText.match(new RegExp(e+":"))){var n=t[a].style.content;return n?n.replace(/"/g,"").replace(/'/g,""):"?"}},this.showModal=function(e){e?$("#shade").fadeIn():$("#shade").fadeOut()},this.dateFromString=function(e){var t=e.match(/(\d+)-(\d+)-(\d+)_(\d+):(\d+):(\d+).*/);return t?new Date(+t[1],+t[2]-1,+t[3],+t[4],+t[5],+t[6]):new Date},this.diffMinutes=function(e,t){return diff=new Date(t-e),(diff/1e3/60).toFixed(0)},Date.prototype.yyyymmdd=function(){var e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),a=this.getDate().toString();return e+"-"+(t[1]?t:"0"+t[0])+"-"+(a[1]?a:"0"+a[0])},Date.prototype.hhmm=function(){var e=this.getHours().toString(),t=this.getMinutes().toString();return(e[1]?e:"0"+e[0])+":"+(t[1]?t:"0"+t[0])},Date.prototype.hhmmss=function(){var e=this.getHours().toString(),t=this.getMinutes().toString(),a=this.getSeconds().toString();return(e[1]?e:"0"+e[0])+":"+(t[1]?t:"0"+t[0])+":"+(a[1]?a:"0"+a[0])},Date.prototype.ddmm=function(){var e=(this.getMonth()+1).toString(),t=this.getDate().toString();return(t[1]?t:"0"+t[0])+"."+(e[1]?e:"0"+e[0])+"."},this.indexOfGeneric=function(e,t){if(!e)return-1;for(var a=0;a<e.length;a++)if(!$.isNumeric(e[a]))return indexOfRegex(e,t);return indexOfNumeric(e,t)},this.indexOfNumeric=function(e,t){for(var a=-1,n=0;n<e.length;n++)Number(t)>=Number(e[n])&&(a=n);return a},this.indexOfRegex=function(e,t){for(var a=0;a<e.length;a++)try{var n=t.match(new RegExp("^"+e[a]+"$"));if(n)return a}catch(r){}return e.indexOf(t)};
